<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <div th:replace="~{fragment :: meta}"></div>
  <div th:replace="~{fragment :: styles}"></div>
  <title>料金ルール設定</title>
</head>
<body>
<div class="samuraitravel-wrapper">
  <div th:replace="~{fragment :: header}"></div>

  <main>
    <div class="container pt-4 pb-5 samuraitravel-container">
      <div class="row justify-content-center">
        <div class="col-xxl-9 col-xl-10 col-lg-11">

          <nav class="my-3" aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a th:href="@{/}">ホーム</a></li>
              <li class="breadcrumb-item"><a th:href="@{/host/rooms}">スタジオ一覧</a></li>
              <li class="breadcrumb-item active" aria-current="page">料金ルール設定</li>
            </ol>
          </nav>

          <h1 class="mb-3">料金ルール設定（<span th:text="${room.name}">Room</span>）</h1>

          <div th:if="${saved}" class="alert alert-success">料金ルールを追加しました。</div>
          <div th:if="${deleted}" class="alert alert-warning">料金ルールを削除しました。</div>

          <form th:action="@{/host/rooms/{id}/price-rules(id=${form.roomId})}" method="post" th:object="${form}">
            <input type="hidden" th:field="*{roomId}"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">
              入力に誤りがあります。各項目をご確認ください。
            </div>

            <!-- 1件追加方式：rows[0] だけ使用 -->
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                <tr>
                  <th style="width: 12%">タイプ</th>
                  <th style="width: 10%">曜日</th>
                  <th style="width: 12%">開始</th>
                  <th style="width: 12%">終了</th>
                  <th style="width: 14%">倍率</th>
                  <th style="width: 14%">固定費</th>
                  <th>メモ</th>
                </tr>
                </thead>
                <tbody id="rule-rows" th:with="i=${0}">
                <tr>
                  <input type="hidden" th:field="*{rows[__${i}__].id}" value=""/>

                  <!-- タイプ -->
                  <td>
                    <select class="form-select rule-type" th:field="*{rows[__${i}__].ruleType}">
                      <option value="">選択</option>
                      <option value="multiplier">倍率</option>
                      <option value="flat_fee">固定費</option>
                    </select>
                  </td>

                  <!-- 曜日 -->
                  <td>
                    <select class="form-select" th:field="*{rows[__${i}__].weekday}">
                      <option th:value="${null}">全て</option>
                      <option th:value="0">日</option>
                      <option th:value="1">月</option>
                      <option th:value="2">火</option>
                      <option th:value="3">水</option>
                      <option th:value="4">木</option>
                      <option th:value="5">金</option>
                      <option th:value="6">土</option>
                    </select>
                  </td>

                  <!-- 15分刻みの <select>（ブラウザ依存なし） -->
                  <td>
                    <select class="form-select time-start" th:field="*{rows[__${i}__].startHour}" data-quarter-select></select>
                  </td>
                  <td>
                    <select class="form-select time-end" th:field="*{rows[__${i}__].endHour}" data-quarter-select></select>
                  </td>

                  <!-- 倍率 / 固定費 -->
                  <td><input type="number" step="0.01" min="0" class="form-control multiplier" th:field="*{rows[__${i}__].multiplier}" placeholder="例 1.50"></td>
                  <td><input type="number" step="1" min="0" class="form-control flat-fee" th:field="*{rows[__${i}__].flatFee}" placeholder="例 2000"></td>

                  <!-- メモ -->
                  <td><input type="text" class="form-control" th:field="*{rows[__${i}__].note}"></td>
                </tr>
                </tbody>
              </table>
            </div>

            <div class="d-flex gap-2">
              <!-- 「行を追加」ボタンは削除 -->
              <button type="submit" class="btn samuraitravel-btn text-white shadow-sm">追加する</button>
            </div>
          </form>

          <!-- 現在の設定（DB状態） -->
          <hr class="my-4"/>
          <h2 class="h5 mb-3">現在の設定（保存済み）</h2>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
              <tr>
                <th style="width:10%">タイプ</th>
                <th style="width:10%">曜日</th>
                <th style="width:12%">開始</th>
                <th style="width:12%">終了</th>
                <th style="width:12%">倍率</th>
                <th style="width:12%">固定費</th>
                <th>メモ</th>
                <th style="width:10%">操作</th>
              </tr>
              </thead>
              <tbody>
              <tr th:if="${#lists.isEmpty(rules)}">
                <td colspan="8" class="text-muted">保存済みのルールはありません。</td>
              </tr>
              <tr th:each="r : ${rules}">
                <td th:text="${r.ruleType == 'multiplier' ? '倍率' : (r.ruleType == 'flat_fee' ? '固定費' : r.ruleType)}"></td>
                <td>
                  <span th:switch="${r.weekday}">
                    <span th:case="${null}">全て</span>
                    <span th:case="0">日</span>
                    <span th:case="1">月</span>
                    <span th:case="2">火</span>
                    <span th:case="3">水</span>
                    <span th:case="4">木</span>
                    <span th:case="5">金</span>
                    <span th:case="6">土</span>
                    <span th:case="*">-</span>
                  </span>
                </td>
                <td th:text="${r.startHour != null ? #temporals.format(r.startHour,'HH:mm') : '-'}"></td>
                <td th:text="${r.endHour   != null ? #temporals.format(r.endHour  ,'HH:mm') : '-'}"></td>
                <td th:text="${r.multiplier != null ? r.multiplier : '-'}"></td>
                <td th:text="${r.flatFee    != null ? r.flatFee    : '-'}"></td>
                <td th:text="${r.note}">-</td>
                <td>
                  <form th:action="@{/host/rooms/{roomId}/price-rules/{ruleId}/delete(roomId=${room.id}, ruleId=${r.id})}" method="post" class="d-inline">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('このルールを削除します。よろしいですか？');">削除</button>
                  </form>
                </td>
              </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </main>

  <div th:replace="~{fragment :: footer}"></div>
</div>

<div th:replace="~{fragment :: scripts}"></div>

<script th:inline="none">
  // 00:00〜23:45を15分刻みで生成
  function fillQuarterOptions(selectEl, currentValue) {
    selectEl.innerHTML = '<option value=""></option>';
    for (let h = 0; h < 24; h++) {
      for (let m of [0, 15, 30, 45]) {
        const hh = String(h).padStart(2, '0');
        const mm = String(m).padStart(2, '0');
        const v = `${hh}:${mm}`;
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        if (currentValue && currentValue === v) opt.selected = true;
        selectEl.appendChild(opt);
      }
    }
  }

  // 種別に応じて相互排他
  function applyTypeDisabling(root) {
    const typeSel = root.querySelector('.rule-type');
    const startSel = root.querySelector('.time-start');
    const endSel   = root.querySelector('.time-end');
    const mulInp  = root.querySelector('.multiplier');
    const feeInp  = root.querySelector('.flat-fee');

    const update = () => {
      const t = typeSel.value;
      if (t === 'flat_fee') {
        startSel.disabled = true; endSel.disabled = true; mulInp.disabled = true;
        feeInp.disabled = false;
      } else if (t === 'multiplier') {
        startSel.disabled = false; endSel.disabled = false; mulInp.disabled = false;
        feeInp.disabled = true;
      } else {
        // 未選択: 全て入力不可にして誤入力予防
        startSel.disabled = true; endSel.disabled = true; mulInp.disabled = true; feeInp.disabled = true;
      }
    };
    typeSel.addEventListener('change', update);
    update();
  }

  (function () {
    // 15分 select を埋める
    document.querySelectorAll('[data-quarter-select]').forEach(sel => {
      const preset = sel.getAttribute('value') || sel.value; // Thymeleafの既定値も考慮
      fillQuarterOptions(sel, preset);
    });

    // 相互排他（1行のみ）
    const tbody = document.getElementById('rule-rows');
    const row = tbody?.querySelector('tr');
    if (row) applyTypeDisabling(row);
  })();
</script>
</body>
</html>


